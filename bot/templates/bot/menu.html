<!DOCTYPE html>
<html lang="tg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ú–µ–Ω—é —Ö”Ø—Ä–æ–∫–∏ –º–æ</title>
  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #000000;
      --item-bg: #f9f9f9;
    }

    body.dark {
      --bg-color: #121212;
      --text-color: #ffffff;
      --item-bg: #1e1e1e;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: sans-serif;
      padding: 20px;
    }

    .menu-item {
      background-color: var(--item-bg);
      margin: 10px 0;
      padding: 15px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .menu-item img {
      max-width: 50px;
      max-height: 50px;
      margin-right: 15px;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .cart {
      margin-top: 30px;
    }

    button {
      cursor: pointer;
      padding: 5px 10px;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 4px;
    }

    input[type="number"] {
      width: 50px;
      margin: 0 10px;
    }

    #popup {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 999;
    }
  </style>
</head>
<body>

<div class="controls">
  <div>
    <label for="sort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å:</label>
    <select id="sort" onchange="sortMenu()">
      <option value="default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
      <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —Ü–µ–Ω—ã</option>
      <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é —Ü–µ–Ω—ã</option>
    </select>
  </div>
  <button onclick="toggleTheme()">üåó –¢–µ–º–∞</button>
</div>

<h1>–ú–µ–Ω—é —Ö”Ø—Ä–æ–∫–∏ –º–æ</h1>

<div id="menu">
  {% for dish in dishes %}
    <div class="menu-item" data-price="{{ dish.price }}">
      <img src="{{ dish.image.url }}" alt="{{ dish.name }}">
      <span>{{ dish.name }}</span>
      <span>{{ dish.price }} —Å–æ–º–æ–Ω”£</span>
      <input type="number" min="1" value="1">
      <button onclick="addToCart('{{ dish.name }}', '{{ dish.price }}', this)">‚ûï</button>

    </div>
  {% endfor %}
</div>

<div class="cart">
  <h2>üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
  <ul id="cart-items"></ul>
  <button onclick="confirmOrder()">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
</div>

<div id="popup"></div>

<script>
  const menuContainer = document.getElementById('menu');
  const cartList = document.getElementById('cart-items');

  function toggleTheme() {
    document.body.classList.toggle('dark');
  }

  function sortMenu() {
    const sortType = document.getElementById('sort').value;
    const items = Array.from(menuContainer.children);

    if (sortType === 'asc') {
      items.sort((a, b) => parseFloat(a.dataset.price) - parseFloat(b.dataset.price));
    } else if (sortType === 'desc') {
      items.sort((a, b) => parseFloat(b.dataset.price) - parseFloat(a.dataset.price));
    }

    items.forEach(item => menuContainer.appendChild(item));
  }

  function addToCart(name, price, btn) {
    const quantity = parseInt(btn.previousElementSibling.value) || 1;
    const cart = JSON.parse(localStorage.getItem('cart')) || [];

    const existing = cart.find(item => item.name === name);
    if (existing) {
      existing.qty += quantity;
    } else {
      cart.push({ name, price, qty: quantity });
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
  }

  function renderCart() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    cartList.innerHTML = cart.map(item =>
      `<li>${item.name} ‚Äî ${item.qty} —à—Ç. = ${item.qty * item.price} —Å–æ–º–æ–Ω”£</li>`
    ).join('');
  }

  function confirmOrder() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];

    if (cart.length === 0) {
      showPopup("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
      return;
    }

    const orderData = {
      customer_name: "–ì–æ—Å—Ç—å",
      items: cart.map(item => ({
        name: item.name,
        quantity: item.qty,
        price: item.price
      }))
    };

    fetch('/api/orders/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
      showPopup("üéâ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!");
      localStorage.removeItem('cart');
      renderCart();
    })
    .catch(err => {
      console.error(err);
      showPopup("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ");
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showPopup(message) {
    const popup = document.getElementById('popup');
    popup.textContent = message;
    popup.style.display = 'block';
    setTimeout(() => {
      popup.style.display = 'none';
    }, 3000);
  }

  renderCart();
</script>

</body>
</html>
