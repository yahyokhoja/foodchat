<!-- templates/menu.html -->
{% extends 'bot/base.html' %}

{% block title %}–ú–µ–Ω—é{% endblock %}

{% block content %}

<div class="controls">
  <label for="sort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å:</label>
  <select id="sort" onchange="sortMenu()">
    <option value="default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
    <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —Ü–µ–Ω—ã</option>
    <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é —Ü–µ–Ω—ã</option>
  </select>
</div>

<div id="menu">
  {% for dish in dishes %}
    <div class="menu-item" data-price="{{ dish.price }}">
      <img src="{{ dish.image.url }}" alt="{{ dish.name }}" style="max-width:50px; max-height:50px;">
      <span>{{ dish.name }}</span>
      <span>{{ dish.price }} —Å–æ–º–æ–Ω”£</span>
      <input type="number" min="1" value="1">
      <button onclick="addToCart('{{ dish.name }}', '{{ dish.price }}', this)">‚ûï</button>
    </div>
  {% endfor %}
</div>

<div class="cart">
  <h2>üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
  <ul id="cart-items"></ul>
  <button onclick="confirmOrder()">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
</div>

<script>
  const menuContainer = document.getElementById('menu');
  const cartList = document.getElementById('cart-items');

  function sortMenu() {
    const sortType = document.getElementById('sort').value;
    const items = Array.from(menuContainer.children);

    if (sortType === 'asc') {
      items.sort((a, b) => parseFloat(a.dataset.price) - parseFloat(b.dataset.price));
    } else if (sortType === 'desc') {
      items.sort((a, b) => parseFloat(b.dataset.price) - parseFloat(a.dataset.price));
    }

    items.forEach(item => menuContainer.appendChild(item));
  }

  function addToCart(name, price, btn) {
    const quantity = parseInt(btn.previousElementSibling.value) || 1;
    const cart = JSON.parse(localStorage.getItem('cart')) || [];

    const existing = cart.find(item => item.name === name);
    if (existing) {
      existing.qty += quantity;
    } else {
      cart.push({ name, price, qty: quantity });
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
  }

  function renderCart() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    cartList.innerHTML = cart.map((item, index) =>
      `<li>
        ${item.name} ‚Äî ${item.qty} —à—Ç. = ${item.qty * item.price} —Å–æ–º–æ–Ω”£
        <button onclick="updateQuantity(${index}, 'increase')">‚ûï</button>
        <button onclick="updateQuantity(${index}, 'decrease')">‚ûñ</button>
        <button onclick="removeItem(${index})">‚ùå</button>
      </li>`
    ).join('');
  }

  function updateQuantity(index, action) {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    if (action === 'increase') {
      cart[index].qty += 1;
    } else if (action === 'decrease' && cart[index].qty > 1) {
      cart[index].qty -= 1;
    }
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
  }

  function removeItem(index) {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
  }

  function confirmOrder() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];

    if (cart.length === 0) {
      showPopup("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
      return;
    }

    const orderData = {
      customer_name: "–ì–æ—Å—Ç—å",
      items: cart.map(item => ({
        name: item.name,
        quantity: item.qty,
        price: item.price
      }))
    };

    fetch('/api/orders/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
      showPopup("üéâ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!");
      localStorage.removeItem('cart');
      renderCart();
    })
    .catch(err => {
      console.error(err);
      showPopup("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ");
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  renderCart();
</script>

{% endblock %}
